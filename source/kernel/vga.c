#include "vga.h"

#define VMEM ((uint8_t*) 0xA0000)

#define	__VGA_AC_INDEX__		0x3C0
#define	__VGA_AC_WRITE__		0x3C0
#define	__VGA_AC_READ__ 		0x3C1
#define	__VGA_MISC_WRITE__		0x3C2
#define __VGA_SEQ_INDEX__		0x3C4
#define __VGA_SEQ_DATA__		0x3C5
#define	__VGA_DAC_READ__    	0x3C7
#define	__VGA_DAC_WRITE__   	0x3C8
#define	__VGA_DAC_DATA__		0x3C9
#define	__VGA_MISC_READ__		0x3CC
#define __VGA_GC_INDEX__ 		0x3CE
#define __VGA_GC_DATA__ 		0x3CF
#define __VGA_CRTC_INDEX__		0x3D4
#define __VGA_CRTC_DATA__		0x3D5
#define	__VGA_INSTAT_READ__		0x3DA

#define	__VGA_SEQ_REGS_COUNT__	5
#define	__VGA_CRTC_REGS_COUNT__	25
#define	__VGA_GC_REGS_COUNT__	9
#define	__VGA_AC_REGS_COUNT__	21

uint8_t w320_h200_c256[] = {
/* MISC */
	0x63,
/* SEQ */
	0x03, 0x01, 0x0F, 0x00, 0x0E,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F,
	0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x9C, 0x0E, 0x8F, 0x28,	0x40, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x41, 0x00, 0x0F, 0x00,	0x00
};

uint8_t w720_h480_c16[] = {
/* MISC */
	0xE7,
/* SEQ */
	0x03, 0x01, 0x08, 0x00, 0x06,
/* CRTC */
	0x6B, 0x59, 0x5A, 0x82, 0x60, 0x8D, 0x0B, 0x3E,
	0x00, 0x40, 0x06, 0x07, 0x00, 0x00, 0x00, 0x00,
	0xEA, 0x0C, 0xDF, 0x2D, 0x08, 0xE8, 0x05, 0xE3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x01, 0x00, 0x0F, 0x00, 0x00,
};

uint8_t text_w80_h25[] = {
/* MISC */
	0x67,
/* SEQ */
	0x03, 0x00, 0x03, 0x00, 0x02,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F,
	0x00, 0x4F, 0x0D, 0x0E, 0x00, 0x00, 0x00, 0x50,
	0x9C, 0x0E, 0x8F, 0x28, 0x1F, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x0C, 0x00, 0x0F, 0x08, 0x00
};

void write_vga_regs(uint8_t *regs);

void init_vga(uint32_t options) {
    write_vga_regs(w320_h200_c256);
}

void write_vga_regs(uint8_t *regs) {
/* MISC */
	outb(__VGA_MISC_WRITE__, *regs);
	regs++;
/* SEQ */
	for(int i = 0; i < __VGA_SEQ_REGS_COUNT__; i++)
	{
		outb(__VGA_SEQ_INDEX__, i);
		outb(__VGA_SEQ_DATA__, *regs);
		regs++;
	}
/* CRTC */
/* unlock CRTC regs */
	outb(__VGA_CRTC_INDEX__, 0x03);
	outb(__VGA_CRTC_DATA__, inb(__VGA_CRTC_DATA__) | 0x80);
	outb(__VGA_CRTC_INDEX__, 0x11);
	outb(__VGA_CRTC_DATA__, inb(__VGA_CRTC_DATA__) & ~0x80);
	regs[0x03] |= 0x80;
	regs[0x11] &= ~0x80;
	for(int i = 0; i < __VGA_CRTC_REGS_COUNT__; i++)
	{
		outb(__VGA_CRTC_INDEX__, i);
		outb(__VGA_CRTC_DATA__, *regs);
		regs++;
	}
/* lock CRTC regs */
    outb(__VGA_CRTC_INDEX__, 0x11);
	outb(__VGA_CRTC_DATA__, inb(__VGA_CRTC_DATA__) | 0x80);
    outb(__VGA_CRTC_INDEX__, 0x03);
	outb(__VGA_CRTC_DATA__, inb(__VGA_CRTC_DATA__) & ~0x80);
/* GC */
	for(int i = 0; i < __VGA_GC_REGS_COUNT__; i++)
	{
		outb(__VGA_GC_INDEX__, i);
		outb(__VGA_GC_DATA__, *regs);
		regs++;
	}
/* AC */
	for(int i = 0; i < __VGA_AC_REGS_COUNT__; i++)
	{
		(void)inb(__VGA_INSTAT_READ__);
		outb(__VGA_AC_INDEX__, i);
		outb(__VGA_AC_WRITE__, *regs);
		regs++;
	}
	(void)inb(__VGA_INSTAT_READ__);
	outb(__VGA_AC_INDEX__, 0x20);
}